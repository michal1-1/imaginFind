<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×”×™×¡×˜×•×¨×™×™×ª ×—×™×¤×•×©×™ ×”×ª××•× ×•×ª</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; 
            padding: 20px; 
            color: #333;
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; 
            padding: 40px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        h1 { 
            color: #333; 
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            font-style: italic;
        }
        
        .search-item { 
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            margin: 25px 0; 
            padding: 30px; 
            border-radius: 20px; 
            border-left: 6px solid #667eea;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .search-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
            border-left-color: #4f46e5;
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-query { 
            font-weight: 700; 
            font-size: 1.4rem; 
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 250px;
        }
        
        .query-icon {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .search-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .search-date { 
            color: #64748b; 
            font-size: 0.95rem; 
            background: #f1f5f9;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .results-count { 
            background: linear-gradient(45deg, #10b981, #059669); 
            color: white; 
            padding: 8px 20px; 
            border-radius: 25px; 
            font-size: 0.9rem; 
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 15px;
            border: 2px dashed #cbd5e1;
        }
        
        .image-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .image-container:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
            z-index: 10;
        }
        
        .image-thumb {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 15px 10px 10px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-container:hover .image-overlay {
            opacity: 1;
        }
        
        .score-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .loading { 
            text-align: center; 
            padding: 60px; 
            color: #666;
            font-size: 1.3rem;
        }
        
        .loading::before {
            content: 'â³';
            font-size: 3rem;
            display: block;
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .no-history {
            text-align: center;
            padding: 60px;
            color: #64748b;
            font-size: 1.2rem;
            background: #f8fafc;
            border-radius: 15px;
            border: 2px dashed #cbd5e1;
        }
        
        .no-history::before {
            content: 'ğŸ“­';
            font-size: 4rem;
            display: block;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .modal-image {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
        }
        
        .modal-info {
            padding: 20px;
            background: white;
            text-align: center;
        }
        
        .empty-grid {
            grid-column: 1/-1;
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 40px;
            background: white;
            border-radius: 10px;
            border: 2px dashed #cbd5e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¸ ×”×™×¡×˜×•×¨×™×™×ª ×—×™×¤×•×©×™ ×”×ª××•× ×•×ª</h1>
            <div class="subtitle">×›×œ ×”×—×™×¤×•×©×™× ×©×œ×š ×¢× ×”×ª××•× ×•×ª ×©× ××¦××•</div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="loadHistory()">
                ğŸ”„ ×¨×¢× ×Ÿ ×”×™×¡×˜×•×¨×™×”
            </button>
            <button class="btn btn-danger" onclick="clearHistory()">
                ğŸ—‘ï¸ × ×§×” ×”×™×¡×˜×•×¨×™×”
            </button>
        </div>
        
        <div id="historyContainer">
            <div class="loading">×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×” ××“×”×™××”...</div>
        </div>
    </div>
    
    <div class="image-modal" id="imageModal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img class="modal-image" id="modalImage">
            <div class="modal-info">
                <div id="modalCaption"></div>
            </div>
        </div>
    </div>
    
    <script>
        async function loadHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '<div class="loading">×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×” ××“×”×™××”...</div>';
            
            try {
                const response = await fetch('http://127.0.0.1:8001/search_history');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ğŸ“Š × ×ª×•× ×™ ×”×™×¡×˜×•×¨×™×”:', data);
                
                if (data.searches && data.searches.length > 0) {
                    container.innerHTML = '';
                    
                    for (const search of data.searches) {
                        const searchDiv = document.createElement('div');
                        searchDiv.className = 'search-item';
                        
                        const date = new Date(search.timestamp).toLocaleString('he-IL');
                        const resultsCount = search.results?.length || search.results_count || 0;
                        
                        searchDiv.innerHTML = `
                            <div class="search-header">
                                <div class="search-query">
                                    <div class="query-icon">ğŸ”</div>
                                    ${search.query}
                                </div>
                                <div class="search-meta">
                                    <div class="search-date">ğŸ“… ${date}</div>
                                    <div class="results-count">
                                        ğŸ“Š ${resultsCount} ×ª×•×¦××•×ª
                                    </div>
                                </div>
                            </div>
                            <div class="images-grid">
                                ${renderImageResults(search.results || [])}
                            </div>
                        `;
                        
                        container.appendChild(searchDiv);
                    }
                } else {
                    container.innerHTML = `
                        <div class="no-history">
                            ××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×—×™×¤×•×©×™× ×¢×“×™×™×Ÿ<br>
                            <small>×‘×¦×¢ ×—×™×¤×•×© ×›×œ×©×”×• ×›×“×™ ×œ×¨××•×ª ×›××Ÿ ××ª ×”×ª×•×¦××•×ª ×¢× ×”×ª××•× ×•×ª</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”:', error);
                container.innerHTML = `
                    <div class="no-history">
                        âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×”<br>
                        <small>× ×¡×” ×œ×¨×¢× ×Ÿ ××• ×‘×“×•×§ ×©×”×©×¨×ª ×¤×•×¢×œ</small><br>
                        <code>${error.message}</code>
                    </div>
                `;
            }
        }
        
        function renderImageResults(results) {
            if (!results || results.length === 0) {
                return '<div class="empty-grid">ğŸš« ××™×Ÿ ×ª××•× ×•×ª ×‘×—×™×¤×•×© ×–×”</div>';
            }
            
            return results.slice(0, 8).map((result, index) => {
                let imageUrl = '';
                
                if (result.path && result.path.startsWith('http')) {
                    imageUrl = result.path;
                } else if (result.path && result.filename) {
                    imageUrl = `http://127.0.0.1:8001/image/?filename=${encodeURIComponent(result.filename)}&folder_path=${encodeURIComponent(result.path)}`;
                } else {
                    return '';
                }
                
                const caption = (result.caption || '×ª××•× ×”').substring(0, 50) + (result.caption?.length > 50 ? '...' : '');
                
                return `
                    <div class="image-container" onclick="openModal('${imageUrl}', '${result.caption || '×ª××•× ×”'}')">
                        <img 
                            class="image-thumb" 
                            src="${imageUrl}" 
                            alt="${result.caption || '×ª××•× ×”'}"
                            loading="lazy"
                            onerror="this.style.display='none'"
                        >
                        <div class="score-badge">â­ ${result.score || 'N/A'}</div>
                        <div class="image-overlay">
                            ${caption}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openModal(imageSrc, caption) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            
            modalImage.src = imageSrc;
            modalCaption.textContent = caption;
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        
        async function clearHistory() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×”?')) {
                return;
            }
            
            try {
                const response = await fetch('http://127.0.0.1:8001/clear_search_history', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('âœ… ×”×”×™×¡×˜×•×¨×™×” × ××—×§×” ×‘×”×¦×œ×—×”');
                    loadHistory();
                } else {
                    alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×”×™×¡×˜×•×¨×™×”');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘××—×™×§×ª ×”×™×¡×˜×•×¨×™×”:', error);
                alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×”×™×¡×˜×•×¨×™×”');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>